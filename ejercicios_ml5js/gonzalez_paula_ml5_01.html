<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ML5 01 · Cámara + Detección</title>

  <!-- ml5.js (versión fija para evitar cambios de API) -->
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    #wrap { position: relative; width: min(720px, 100%); }
    video, canvas { width: 100%; height: auto; border-radius: 10px; }
    canvas { position: absolute; left: 0; top: 0; }
    button { padding: 10px 12px; font-size: 14px; cursor: pointer; }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; margin-bottom: 10px; }
    .badge { display:inline-block; border:1px solid #ccc; border-radius:999px; padding: 3px 10px; }
  </style>
</head>

<body>
  <h1>ML5 01 · Cámara en móvil + detección</h1>

  <div class="row">
    <button id="btnStart">Iniciar cámara</button>
    <span id="status" class="badge">Estado: esperando…</span>
    <span id="best" class="badge">Mejor detección: —</span>
  </div>

  <div id="wrap">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div>
   <h3> Explicación de cómo funciona el código</h3>

   <p> Al principio del style, crea el apartado "head", en el que pone el idioma en el  que se va a hablar, el título que aparece arriba
   donde la página que se abre y el link necesario para que el documento funcione. Luego, también dentro de este head, pone las diferentes
   clases que va a utilizar más adelante con sus correspondientes particularidades. 
   </p>
   <p> Después, en el body, crea un h1 en el que explica lo que se va a hacer en la tarea: una cámara con detección, luego nombra una clase con las
   particularidades concretadas antes en el head, y crea unos botones y un span para explicar lo que se esta ejecutando. A continuación, nombra
   otra clase diferente y crea un video y un canvas concreto en el que se mostrará la cámara. Luego crea otro h3 (más pequeño que el anterior,
   como si fuera un subtítulo) en el explica que pondré esta explicación y genera estos párrafos sobre los que estoy escribiendo.</p>
   <p> Luego crea otro script, en el que busca diferentes elementos nombrados antes en la página poniendo "const" y luego crea diferentes variables
   poniendo "let" y su estado de iniciación.</p>
   <p>Después crea una "function" en la que va a poner todo lo que va a ocurrir a continuación: primero da explicaciones para poder abrir la 
   cámara del dispostivo en el que se vaya a abrir la página web (en caso del móvil se intentará la cámara trasera) y luego ajustará el canvas
   al tamaño real del vídeo.</p>
   <p>A continuación crea otra function pero esta vez un draw, que se generara 60vps, en el que va a detectar los diferentes objetos que vayan
   apareciendo en la cámara, dibujando un rectángulo alrededor del objeto, indicando el nombre de este y la probabilidad (en porcentaje)
   de que el objeto sea el que se indica.</p>
   <p> Luego crea otra function que se llama "pickBest", aquí lo que se va a hacer es aprender a diferenciar objetos en función de su claridad, para que el programa remarque solo los objetos
   que vayan a tener más porcentaje de ser lo que se indica.</p>
   <p> La siguiente function que utiliza se llama "loopDetect" y la utiliza para asegurarse de que todo lo realizado anteriormente se realice correctamente, así, si el
   programa tiene algún problema, en esta función se verá solucionado directamente sin necesidad de tener que cambiarlo tú manualmente.</p>
   

  </div>


  <script>
    const btnStart = document.getElementById("btnStart");
    const statusEl = document.getElementById("status");
    const bestEl = document.getElementById("best");

    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");

    let detector = null;
    let running = false;

    function setStatus(t) { statusEl.textContent = "Estado: " + t; }

    async function initCamera() {
      // En móvil, "environment" intenta usar la cámara trasera
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });

      video.srcObject = stream;

      await new Promise(res => video.onloadedmetadata = () => res());

      // Ajustar canvas al tamaño real del vídeo
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    function draw(detections) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 3;
      ctx.font = "16px system-ui, Arial";

      for (const d of detections) {
        ctx.strokeRect(d.x, d.y, d.width, d.height);
        const label = `${d.label} (${Math.round(d.confidence * 100)}%)`;
        ctx.fillText(label, d.x + 6, Math.max(16, d.y + 16));
      }
    }

    function pickBest(detections) {
      if (!detections || detections.length === 0) return null;
      let best = detections[0];
      for (const d of detections) {
        if (d.confidence > best.confidence) best = d;
      }
      return best;
    }

    function loopDetect() {
      if (!running || !detector) return;

      detector.detect(video, (err, results) => {
        if (err) {
          console.error(err);
          setStatus("error en detección (ver consola)");
          running = false;
          return;
        }

        draw(results);

        const best = pickBest(results);
        bestEl.textContent = best
          ? `Mejor detección: ${best.label} (${Math.round(best.confidence * 100)}%)`
          : "Mejor detección: —";

        requestAnimationFrame(loopDetect);
      });
    }

    btnStart.addEventListener("click", async () => {
      try {
        btnStart.disabled = true;

        setStatus("iniciando cámara…");
        await initCamera();

        setStatus("cargando modelo COCO-SSD…");
        detector = await ml5.objectDetector("cocossd");

        setStatus("detectando…");
        running = true;
        loopDetect();

      } catch (e) {
        console.error(e);
        setStatus(`error: ${e.name} — ${e.message}`);
        btnStart.disabled = false;
      }
    });
  </script>
</body>
</html>
